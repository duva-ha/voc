<div class="main-container">
    <div class="sidebar">
        <div id="qrcode" style="background: white; padding: 10px; border-radius: 10px; margin-bottom: 15px;"></div>
        <div style="background: #000; padding: 15px; border-radius: 15px;">
            <div style="font-size: 0.8rem; color: #666;">ĐÃ THAM GIA</div>
            <div id="totalCount" style="font-size: 2.5rem; font-weight: 900; color: gold;">0</div>
        </div>
        <button onclick="resetSystemData()" style="margin-top: 20px; background: none; border: 1px solid #444; color: #666; cursor: pointer; padding: 5px 10px; border-radius: 5px;">Xóa danh sách lớp</button>
    </div>

    <div class="card">
        <div class="tabs">
            <button id="tLucky" class="tab active" onclick="switchMode('lucky')">QUAY SỐ</button>
            <button id="tQuiz" class="tab" onclick="switchMode('quiz')">TRẮC NGHIỆM</button>
        </div>

        <div id="luckySection">
            <div class="slot-box">
                <div id="d1" class="slot">0</div><div id="d2" class="slot">0</div>
                <div id="d3" class="slot">0</div><div id="d4" class="slot">0</div>
                <div id="d5" class="slot">0</div><div id="d6" class="slot">0</div>
            </div>
            <div id="luckyWinnerName" style="font-size: 2rem; color: gold; font-weight: bold; margin: 15px 0; min-height: 40px;"></div>
            <button class="btn-action" style="background: var(--primary); color: white;" onclick="handleSpin()">BẮT ĐẦU QUAY</button>
        </div>

        <div id="quizSection" style="display:none;">
            <textarea id="qText" placeholder="Nhập câu hỏi..."></textarea>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <input id="ansA" placeholder="Đáp án A"> <input id="ansB" placeholder="Đáp án B">
                <input id="ansC" placeholder="Đáp án C"> <input id="ansD" placeholder="Đáp án D">
            </div>
            <button class="btn-action" style="background: var(--blue); color: white;" onclick="pushQuiz()">CHUYỂN CÂU & MỞ CHUÔNG</button>
            <div id="winner" style="margin-top: 20px; font-size: 2rem; color: #00ff00; font-weight: bold;"></div>
            <button onclick="resetQuizOnly()" style="margin-top: 10px; background: #333; color: #888; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">Làm trống câu hỏi & chuông</button>
        </div>
    </div>
</div>

<script>
    // ... Phần config Firebase giữ nguyên ...

    async function handleSpin() {
        const s = await db.collection("participants").get();
        if(s.empty) return alert("Chưa có học sinh nào đăng ký!");
        
        document.getElementById('luckyWinnerName').innerText = "ĐANG TÌM CHỦ NHÂN...";
        const list = s.docs.map(d => d.data());
        const win = list[Math.floor(Math.random()*list.length)];
        
        await db.collection("system_status").doc("current_draw").set({
            winningNumber: win.number, status: "SPINNING", ts: Date.now()
        });

        // Hiệu ứng quay lồng
        for(let i=0; i<6; i++) {
            const el = document.getElementById('d'+(i+1));
            el.classList.remove('final'); el.classList.add('spinning');
            let start = Date.now();
            while(Date.now()-start < (2000+i*500)) {
                el.innerText = Math.floor(Math.random()*10);
                await new Promise(r => setTimeout(r, 60));
            }
            el.innerText = win.number[i]; el.classList.remove('spinning'); el.classList.add('final');
        }

        // HIỂN THỊ TÊN SAU KHI QUAY XONG
        document.getElementById('luckyWinnerName').innerText = "CHÚC MỪNG: " + win.name.toUpperCase();
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        await db.collection("system_status").doc("current_draw").update({ status: "DONE" });
    }

    // HÀM RESET DỮ LIỆU TOÀN HỆ THỐNG (Dùng khi sang lớp mới)
    async function resetSystemData() {
        if(confirm("Thầy có chắc chắn muốn xóa danh sách học sinh và kết quả cũ không?")) {
            const batch = db.batch();
            const users = await db.collection("participants").get();
            users.forEach(doc => batch.delete(doc.ref));
            
            batch.set(db.collection("system_status").doc("quiz"), { status: "CLOSED", winner: "", q: "" });
            batch.set(db.collection("system_status").doc("current_draw"), { status: "IDLE" });
            
            await batch.commit();
            alert("Đã xóa sạch dữ liệu!");
            location.reload();
        }
    }

    // HÀM RESET RIÊNG CHO PHẦN CHUÔNG
    async function resetQuizOnly() {
        document.getElementById('winner').innerText = "";
        document.getElementById('qText').value = "";
        document.getElementById('ansA').value = "";
        document.getElementById('ansB').value = "";
        document.getElementById('ansC').value = "";
        document.getElementById('ansD').value = "";
        await db.collection("system_status").doc("quiz").set({ status: "CLOSED", winner: "", q: "", opts: ["","","",""] });
    }

    // ... Các hàm khác giữ nguyên ...
</script>
